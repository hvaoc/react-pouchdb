{"version":3,"sources":["../../../src/api/useFind.js"],"names":["PouchDB","plugin","find","changesOptions","live","include_docs","since","return_docs","useListen","useFind","options","db","callee","example","selector","limit","skip","sort","setValue","createIndex","index","fields","map","field","Object","keys","docs","update","changes","deleted","doc","findIndex","_id","found","splice","length","replacementDoc","push","sortOrders","prop","entries","a","b","order","result","sortedIndex","lastDoc","firstDoc"],"mappings":"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","sourcesContent":["import PouchDB from 'pouchdb';\nimport find from 'pouchdb-find';\nimport { collate } from 'pouchdb-collate';\nimport { matchesSelector } from 'pouchdb-selector-core';\nimport reverseArgs from '../utils/reverseArgs';\nimport changes from '../changes';\nimport useDB from '../useDB';\n\nPouchDB.plugin(find);\n\nconst changesOptions = {\n  live: true,\n  include_docs: true,\n  since: 'now',\n  // Documents are kept in memory. 'complete' event can return an empty array.\n  return_docs: false\n};\n\nexport default useListen =>\n  reverseArgs(function useFind(options, db) {\n    db = useDB(db, {\n      callee: 'useFind',\n      example: 'useFind(db, options)'\n    });\n    const { selector, limit, skip, sort } = options;\n\n    return useListen(db, options, async setValue => {\n      if (sort) {\n        await db.createIndex({\n          index: {\n            fields: sort.map(field =>\n              typeof field === 'object' ? Object.keys(field)[0] : field\n            )\n          }\n        });\n      }\n      let { docs } = await db.find(options);\n      const update = () => setValue([...docs]);\n      update();\n      // To find deleted and other non-matching documents, listen all changes and use selector in 'change' event.\n      return db::changes(\n        changesOptions, //\n        async ({ deleted, doc }) => {\n          const index = docs?.findIndex(({ _id }) => doc._id === _id);\n          const found = index !== -1;\n          // Document was deleted or it does not match the selector?\n          if (deleted || (selector && !matchesSelector(doc, selector))) {\n            if (found) {\n              // Remove.\n              docs.splice(index, 1);\n              const { length } = docs;\n              // At the limit?\n              if (length + 1 === limit) {\n                const {\n                  docs: [replacementDoc]\n                } = await db.find({\n                  ...options,\n                  limit: 1,\n                  skip: (options.skip || 0) + length\n                });\n                if (replacementDoc) {\n                  docs.push(replacementDoc);\n                }\n              }\n              update();\n            }\n          } else {\n            if (found) {\n              // Update.\n              docs[index] = doc;\n            } else {\n              // Create.\n              if (!docs) {\n                docs = [];\n              }\n              docs.push(doc);\n            }\n            if (sort) {\n              const sortOrders = sort.map(prop =>\n                typeof prop === 'object'\n                  ? Object.entries(prop)[0]\n                  : // Default sort order is 'asc'\n                    [prop, 'asc']\n              );\n              docs.sort((a, b) => {\n                for (const [prop, order] of sortOrders) {\n                  const result = collate(a[prop], b[prop]);\n                  if (result !== 0) {\n                    return order === 'asc' ? result : -result;\n                  }\n                }\n                return 0;\n              });\n            }\n            const sortedIndex = docs.findIndex(({ _id }) => doc._id === _id);\n            // Document update, new place is supposed to be last, `limit` option is set and limit was reached?\n            if (found && sortedIndex + 1 === limit) {\n              // Get the actual last document.\n              const {\n                docs: [lastDoc]\n              } = await db.find({\n                ...options,\n                limit: 1,\n                skip: (options.skip || 0) + sortedIndex\n              });\n              if (lastDoc?._id !== doc._id) {\n                docs[sortedIndex] = lastDoc;\n              }\n            }\n            // `skip` option is set and document is supposed to be first?\n            if (skip && sortedIndex === 0) {\n              // Get the actual first document.\n              const {\n                docs: [firstDoc]\n              } = await db.find({\n                ...options,\n                limit: 1\n              });\n              if (firstDoc?._id !== doc._id) {\n                docs[0] = firstDoc;\n              }\n            }\n            if (docs.length > limit) {\n              docs.splice(limit);\n            }\n            update();\n          }\n        }\n      );\n    });\n  });\n"],"file":"useFind.js"}