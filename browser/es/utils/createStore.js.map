{"version":3,"sources":["../../../src/utils/createStore.js"],"names":["get","key","getDefault","has","defaultValue","set","createStore","root","Map","path","create","remove","onCleanup","value","parent","chain","map","item","removeChild","pop","delete","size","length","pathCopy","lastKey","leaf","reduce","referenceCounter","cleanup"],"mappings":";;;AAAA;AACA,IAAMA,GAAG,GAAG,SAANA,GAAM,CAASC,GAAT,EAAcC,UAAd,EAA0B;AAAA;;AACpC,SAAO,KAAKC,GAAL,CAASF,GAAT,IACH,KAAKD,GAAL,CAASC,GAAT,CADG,GAEF,YAAM;AACL,QAAMG,YAAY,GAAGF,UAAU,EAA/B;;AACA,IAAA,KAAI,CAACG,GAAL,CAASJ,GAAT,EAAcG,YAAd;;AACA,WAAOA,YAAP;AACD,GAJD,EAFJ;AAOD,CARD;;AAUA,eAAe,SAASE,WAAT,GAAuB;AACpC,MAAMC,IAAI,GAAG,IAAIC,GAAJ,EAAb;AACA,SAAO,UAACC,IAAD,EAAOC,MAAP,EAAkB;AACvB,aAASC,MAAT,OAAsC;AAAA,UAApBC,SAAoB,QAApBA,SAAoB;AAAA,UAATC,KAAS,QAATA,KAAS;AACpCD,MAAAA,SAAS,SAAT,IAAAA,SAAS,WAAT,YAAAA,SAAS,CAAGC,KAAH,CAAT;AACA,UAAIC,MAAM,GAAGP,IAAb;AACA,UAAMQ,KAAK,GAAGN,IAAI,CAACO,GAAL,CAAS,UAAAf,GAAG,EAAI;AAC5B,YAAMgB,IAAI,GAAG;AAAEH,UAAAA,MAAM,EAANA,MAAF;AAAUb,UAAAA,GAAG,EAAHA;AAAV,SAAb;AACAa,QAAAA,MAAM,GAAGA,MAAM,CAACd,GAAP,CAAWC,GAAX,CAAT;AACA,eAAOgB,IAAP;AACD,OAJa,CAAd;;AAKA,OAAC,SAASC,WAAT,GAAuB;AAAA,yBACEH,KAAK,CAACI,GAAN,EADF;AAAA,YACdL,MADc,cACdA,MADc;AAAA,YACNb,GADM,cACNA,GADM;;AAEtBa,QAAAA,MAAM,CAACM,MAAP,CAAcnB,GAAd;;AACA,YAAI,CAACa,MAAM,CAACO,IAAR,IAAgBN,KAAK,CAACO,MAA1B,EAAkC;AAChCJ,UAAAA,WAAW;AACZ;AACF,OAND;AAOD;;AACD,QAAMK,QAAQ,sBAAOd,IAAP,CAAd;;AACA,QAAMe,OAAO,GAAGD,QAAQ,CAACJ,GAAT,EAAhB;AACA,QAAMM,IAAI,GAAGF,QAAQ,CAACG,MAAT,CACX,UAACZ,MAAD,EAASb,GAAT;AAAA,aAAyBD,GAAR,MAAAc,MAAM,EAAMb,GAAN,EAAW;AAAA,eAAM,IAAIO,GAAJ,EAAN;AAAA,OAAX,CAAvB;AAAA,KADW,EAEXD,IAFW,CAAb;AAIA,QAAMU,IAAI,GAASjB,GAAN,MAAAyB,IAAI,EAAMD,OAAN,EAAe,YAAM;AAAA,oBACTd,MAAM,CAAC;AAAA,eAAMC,MAAM,CAACM,IAAD,CAAZ;AAAA,OAAD,CADG;AAAA;AAAA,UAC7BJ,KAD6B;AAAA,UACtBD,SADsB;;AAEpC,UAAMK,IAAI,GAAG;AACXJ,QAAAA,KAAK,EAALA,KADW;AAEXD,QAAAA,SAAS,EAATA,SAFW;AAGXe,QAAAA,gBAAgB,EAAE;AAHP,OAAb;AAKA,aAAOV,IAAP;AACD,KARgB,CAAjB;AASAA,IAAAA,IAAI,CAACU,gBAAL,GAAwBV,IAAI,CAACU,gBAAL,GAAwB,CAAhD;AACA,WAAO,CACLV,IAAI,CAACJ,KADA,EAEL,SAASe,OAAT,GAAmB;AACjBX,MAAAA,IAAI,CAACU,gBAAL,GAAwBV,IAAI,CAACU,gBAAL,GAAwB,CAAhD;;AACA,UAAI,CAACV,IAAI,CAACU,gBAAV,EAA4B;AAC1BhB,QAAAA,MAAM,CAACM,IAAD,CAAN;AACD;AACF,KAPI,CAAP;AASD,GA1CD;AA2CD","sourcesContent":["// import get from '@postinumero/map-get-with-default';\nconst get = function(key, getDefault) {\n  return this.has(key)\n    ? this.get(key)\n    : (() => {\n        const defaultValue = getDefault();\n        this.set(key, defaultValue);\n        return defaultValue;\n      })();\n};\n\nexport default function createStore() {\n  const root = new Map();\n  return (path, create) => {\n    function remove({ onCleanup, value }) {\n      onCleanup?.(value);\n      let parent = root;\n      const chain = path.map(key => {\n        const item = { parent, key };\n        parent = parent.get(key);\n        return item;\n      });\n      (function removeChild() {\n        const { parent, key } = chain.pop();\n        parent.delete(key);\n        if (!parent.size && chain.length) {\n          removeChild();\n        }\n      })();\n    }\n    const pathCopy = [...path];\n    const lastKey = pathCopy.pop();\n    const leaf = pathCopy.reduce(\n      (parent, key) => parent::get(key, () => new Map()),\n      root\n    );\n    const item = leaf::get(lastKey, () => {\n      const [value, onCleanup] = create(() => remove(item));\n      const item = {\n        value,\n        onCleanup,\n        referenceCounter: 0\n      };\n      return item;\n    });\n    item.referenceCounter = item.referenceCounter + 1;\n    return [\n      item.value,\n      function cleanup() {\n        item.referenceCounter = item.referenceCounter - 1;\n        if (!item.referenceCounter) {\n          remove(item);\n        }\n      }\n    ];\n  };\n}\n"],"file":"createStore.js"}